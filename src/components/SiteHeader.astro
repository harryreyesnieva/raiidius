---
import { siteConfig, getEdition } from "../content/siteConfig";
import Button from "./ui/Button.astro";
import Badge from "./ui/Badge.astro";
import Icon from "./Icon.astro";

export interface Props {
  year: number;
  pathname?: string;
}

const { year, pathname } = Astro.props;
const edition = getEdition(year) ?? siteConfig.editions[0];

const navLinks = [
  { href: "program", label: "Program" },
  { href: "speakers", label: "Speakers" },
  { href: "abstracts", label: "Abstracts" },
  { href: "workshops", label: "Workshops" },
  { href: "venue", label: "Venue" },
  { href: "about", label: "About" },
  { href: "editions", label: "Editions" },
];
const canRegister = Boolean(edition.registrationUrl) && !edition.isComingSoon;
const canSubmit = Boolean(edition.submissionUrl) && !edition.isComingSoon;
const baseUrl = import.meta.env.BASE_URL;
---
<header class="sticky top-0 z-50 border-b border-border bg-card/95 backdrop-blur supports-[backdrop-filter]:bg-card/80">
  <div class="mx-auto flex max-w-7xl items-center justify-between gap-3 px-4 py-3 lg:px-6">
    <div class="flex items-center gap-3">
      <a href={`${import.meta.env.BASE_URL}${year}/`} class="flex items-center gap-2 font-semibold tracking-tight text-foreground">
        <span class="inline-flex h-9 w-9 items-center justify-center rounded-lg bg-primary/10 text-primary">
          <Icon name="Mic" class="h-5 w-5" />
        </span>
        <span class="hidden sm:inline">{siteConfig.seriesAcronym}</span>
        <span class="sr-only">{siteConfig.seriesFullName}</span>
      </a>

      <Badge variant="secondary" class="hidden sm:inline-flex">
        {siteConfig.seriesAcronym} {edition.year}
      </Badge>

      <div class="hidden md:flex items-center gap-2">
        <label for="editionSelect" class="text-xs text-muted-foreground">Edition</label>
        <select
          id="editionSelect"
          class="h-9 rounded-md border border-input bg-background px-3 text-sm text-foreground shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background"
        >
          {siteConfig.editions.map((e) => (
            <option value={e.year} selected={e.year === edition.year}>
              {e.year}{e.isComingSoon ? " (Coming soon)" : ""}
            </option>
          ))}
        </select>
      </div>
    </div>

    <nav class="hidden lg:flex items-center gap-1">
      {navLinks.map((l) => (
        <a
          href={`${import.meta.env.BASE_URL}${year}/${l.href}/`}
          class={`rounded-md px-3 py-2 text-sm text-muted-foreground hover:text-foreground hover:bg-accent focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background ${pathname?.includes('/' + l.href + '/') ? 'bg-accent text-foreground' : ''}`}
        >
          {l.label}
        </a>
      ))}
    </nav>

    <div class="hidden md:flex items-center gap-2">
      <Button href={canSubmit ? edition.submissionUrl : undefined} variant="outline" size="sm" disabled={!canSubmit}>
        Submit
      </Button>
      <Button href={canRegister ? edition.registrationUrl : undefined} variant="primary" size="sm" disabled={!canRegister}>
        Register
      </Button>
      <Button href={`mailto:${edition.contactEmail}`} variant="ghost" size="sm" class="hidden xl:inline-flex">
        <Icon name="Mail" class="h-4 w-4" />
        Contact
      </Button>
    </div>

    <details class="md:hidden">
      <summary class="list-none rounded-md border border-input bg-background px-3 py-2 text-sm shadow-sm cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background">
        Menu
      </summary>
      <div class="mt-2 rounded-lg border border-border bg-card p-3 shadow-lg">
        <div class="flex items-center justify-between gap-2">
          <div class="text-sm font-semibold">{siteConfig.seriesAcronym} {edition.year}</div>
          <select
            id="editionSelectMobile"
            class="h-9 rounded-md border border-input bg-background px-2 text-sm"
          >
            {siteConfig.editions.map((e) => (
              <option value={e.year} selected={e.year === edition.year}>
                {e.year}{e.isComingSoon ? " (Coming soon)" : ""}
              </option>
            ))}
          </select>
        </div>

        <div class="mt-3 grid gap-1">
          {navLinks.map((l) => (
            <a href={`${import.meta.env.BASE_URL}${year}/${l.href}/`} class="rounded-md px-3 py-2 text-sm text-muted-foreground hover:bg-accent hover:text-foreground">
              {l.label}
            </a>
          ))}
        </div>

        <div class="mt-4 grid grid-cols-2 gap-2">
          <Button href={canSubmit ? edition.submissionUrl : undefined} variant="outline" size="sm" disabled={!canSubmit} class="w-full">
            Submit
          </Button>
          <Button href={canRegister ? edition.registrationUrl : undefined} variant="primary" size="sm" disabled={!canRegister} class="w-full">
            Register
          </Button>
          <Button href={`mailto:${edition.contactEmail}`} variant="secondary" size="sm" class="col-span-2 w-full">
            Contact organizers
          </Button>
        </div>
      </div>
    </details>
  </div>

  <script is:inline>
    const STORAGE_KEY = "raiidiusEditionYear";
    function switchEdition(targetYear) {
      try { localStorage.setItem(STORAGE_KEY, String(targetYear)); } catch {}
      const path = window.location.pathname;
      const m = path.match(/\/(20\d{2})(\/.*)?$/);
      if (m) {
        const from = `/${m[1]}`;
        const next = path.replace(from, `/${targetYear}`);
        window.location.assign(next);
      } else {
        const base = {JSON.stringify(baseUrl)}.replace(/\/$/, "");
        window.location.assign(`${base}/${targetYear}/`);
      }
    }
    const sel = document.getElementById("editionSelect");
    const selM = document.getElementById("editionSelectMobile");
    [sel, selM].forEach((el) => {
      if (!el) return;
      el.addEventListener("change", (e) => switchEdition(e.target.value));
    });
  </script>
</header>
