---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import ComingSoonBanner from "../../../components/ComingSoonBanner.astro";
import Badge from "../../../components/ui/Badge.astro";
import Button from "../../../components/ui/Button.astro";
import Card from "../../../components/ui/Card.astro";
import Separator from "../../../components/ui/Separator.astro";
import Icon from "../../../components/Icon.astro";
import { siteConfig, getEdition, getSpeakerById } from "../../../content/siteConfig";
import { getEditionYears } from "../../../lib/editions";
import type { SessionFormat, Session } from "../../../content/types";

export async function getStaticPaths() {
  return getEditionYears().map((year) => ({ params: { year: String(year) } }));
}

const year = Number(Astro.params.year);
const edition = getEdition(year) ?? siteConfig.editions[0];

const formatLabels: Record<SessionFormat, string> = {
  registration: "Registration",
  welcome: "Welcome",
  keynote: "Keynote",
  break: "Break",
  breakout: "Breakout",
  panel: "Panel",
  poster: "Poster",
  session: "Session",
  roundtable: "Roundtable",
  closing: "Closing",
  reception: "Reception",
};

const filterOptions: { value: SessionFormat | "all"; label: string }[] = [
  { value: "all", label: "All" },
  { value: "keynote", label: "Keynotes" },
  { value: "breakout", label: "Breakouts" },
  { value: "panel", label: "Panel" },
  { value: "poster", label: "Posters" },
  { value: "session", label: "Sessions" },
  { value: "roundtable", label: "Roundtable" },
  { value: "reception", label: "Reception" },
  { value: "welcome", label: "Welcome" },
  { value: "registration", label: "Registration" },
  { value: "closing", label: "Closing" },
  { value: "break", label: "Breaks" },
];

function speakerNames(session: Session): string[] {
  return (session.speakers ?? [])
    .map((id) => getSpeakerById(edition, id)?.name)
    .filter(Boolean) as string[];
}
---
<BaseLayout
  year={year}
  title={`Program`}
  description={`Agenda for ${siteConfig.seriesAcronym} ${edition.year} (${edition.themeShortTitle}).`}
>
  <section class="border-b border-border px-4 py-12 lg:px-6">
    <div class="mx-auto max-w-7xl">
      <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="text-3xl font-bold text-foreground">Program</h1>
          <p class="mt-2 text-sm text-muted-foreground">
            {edition.venue} • {edition.address} • {edition.room} • {edition.city}, {edition.state}
          </p>
          <p class="mt-1 text-sm text-muted-foreground">
            {edition.date} • {edition.timezone === "America/New_York" ? "Eastern Time (ET)" : edition.timezone}
          </p>
        </div>

        <div class="flex flex-wrap gap-2 print:hidden">
          <Button variant="outline" href={`${import.meta.env.BASE_URL}calendar/RAIIDIUS-${edition.year}.ics`}>
            <Icon name="CalendarDays" class="h-4 w-4" />
            Add to calendar
          </Button>
          <Button variant="outline" type="button" class="gap-2" onclick="window.print()">
            <Icon name="Printer" class="h-4 w-4" />
            Print / Download
          </Button>
        </div>
      </div>

      {edition.isComingSoon ? (
        <div class="mt-6">
          <ComingSoonBanner year={edition.year} theme={edition.themeTitle} />
        </div>
      ) : null}

      <div class="mt-8 flex flex-wrap items-center gap-2 print:hidden">
        <div class="text-sm font-semibold text-foreground">Filter:</div>
        {filterOptions.map((opt) => (
          <button
            class="rounded-full border border-input bg-background px-3 py-1 text-xs font-medium text-muted-foreground hover:bg-accent hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 ring-offset-background"
            data-filter={opt.value}
          >
            {opt.label}
          </button>
        ))}
      </div>

      <div class="mt-8 grid gap-4">
        {(edition.sessions ?? []).map((s) => (
          <Card class="session-card" data-format={s.format}>
            <div class="p-6">
              <div class="flex flex-col gap-4 md:flex-row md:items-start md:justify-between">
                <div class="min-w-0">
                  <div class="flex flex-wrap items-center gap-2">
                    <div class="text-lg font-semibold text-foreground">{s.title}</div>
                    <Badge variant="secondary">{formatLabels[s.format]}</Badge>
                    {s.track ? <Badge variant="outline">{s.track}</Badge> : null}
                  </div>
                  <p class="mt-2 text-sm text-muted-foreground">{s.description}</p>

                  {speakerNames(s).length ? (
                    <p class="mt-3 text-sm text-muted-foreground">
                      <span class="font-medium text-foreground">Speakers:</span> {speakerNames(s).join(", ")}
                    </p>
                  ) : null}
                </div>

                <div class="shrink-0 text-sm text-muted-foreground md:text-right">
                  <div class="inline-flex items-center gap-2">
                    <Icon name="Clock" class="h-4 w-4 text-primary" />
                    <span class="font-medium text-foreground">{s.startTime}–{s.endTime}</span>
                  </div>
                  <div class="mt-1">{edition.room}</div>
                </div>
              </div>
            </div>
          </Card>
        ))}
      </div>

      <Separator class="my-10" />

      <div class="text-sm text-muted-foreground">
        <p class="print:mt-6">
          Tip: use your browser’s print dialog to save as PDF.
        </p>
      </div>
    </div>
  </section>

  <style is:inline>
    @media print {
      header, footer, .print\:hidden { display: none !important; }
      body { background: white !important; }
      .session-card { break-inside: avoid; }
    }
  </style>

  <script is:inline>
    const buttons = Array.from(document.querySelectorAll("[data-filter]"));
    const cards = Array.from(document.querySelectorAll(".session-card"));
    function setActive(value) {
      buttons.forEach((b) => {
        const isOn = b.getAttribute("data-filter") === value;
        b.classList.toggle("bg-accent", isOn);
        b.classList.toggle("text-foreground", isOn);
        b.classList.toggle("text-muted-foreground", !isOn);
      });
      cards.forEach((c) => {
        const fmt = c.getAttribute("data-format");
        c.style.display = (value === "all" || fmt === value) ? "" : "none";
      });
    }
    buttons.forEach((b) => b.addEventListener("click", () => setActive(b.getAttribute("data-filter"))));
    setActive("all");
  </script>
</BaseLayout>
