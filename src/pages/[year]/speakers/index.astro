---
import BaseLayout from "../../../layouts/BaseLayout.astro";
import ComingSoonBanner from "../../../components/ComingSoonBanner.astro";
import Card from "../../../components/ui/Card.astro";
import Badge from "../../../components/ui/Badge.astro";
import Input from "../../../components/ui/Input.astro";
import Select from "../../../components/ui/Select.astro";
import Icon from "../../../components/Icon.astro";
import { siteConfig, getEdition } from "../../../content/siteConfig";
import { getEditionYears } from "../../../lib/editions";
import type { SpeakerRole } from "../../../content/types";

export async function getStaticPaths() {
  return getEditionYears().map((year) => ({ params: { year: String(year) } }));
}

const year = Number(Astro.params.year);
const edition = getEdition(year) ?? siteConfig.editions[0];

const roles = Array.from(new Set((edition.speakers ?? []).map((s) => s.role))) as SpeakerRole[];
roles.sort();
---
<BaseLayout
  year={year}
  title="Speakers"
  description={`Speakers for ${siteConfig.seriesAcronym} ${edition.year}.`}
>
  <section class="border-b border-border px-4 py-12 lg:px-6">
    <div class="mx-auto max-w-7xl">
      <div class="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
        <div>
          <h1 class="text-3xl font-bold text-foreground">Speakers</h1>
          <p class="mt-2 text-sm text-muted-foreground">
            Search and filter by role across keynotes, panelists, breakout leads, and more.
          </p>
        </div>
      </div>

      {edition.isComingSoon ? (
        <div class="mt-6">
          <ComingSoonBanner year={edition.year} theme={edition.themeTitle} />
        </div>
      ) : null}

      <div class="mt-8 grid gap-3 md:grid-cols-3 print:hidden">
        <div class="md:col-span-2">
          <label class="sr-only" for="speakerSearch">Search speakers</label>
          <div class="relative">
            <span class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">
              <Icon name="Search" class="h-4 w-4" />
            </span>
            <Input id="speakerSearch" class="pl-9" placeholder="Search by name, affiliation, keywordsâ€¦" />
          </div>
        </div>
        <div>
          <label class="sr-only" for="roleFilter">Filter by role</label>
          <Select id="roleFilter">
            <option value="all">All roles</option>
            {roles.map((r) => (
              <option value={r}>{r}</option>
            ))}
          </Select>
        </div>
      </div>

      {(edition.speakers ?? []).length ? (
        <div class="mt-8 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {(edition.speakers ?? []).map((s) => (
            <Card class="speaker-card" data-role={s.role} data-text={`${s.name} ${s.affiliation} ${(s.keywords ?? []).join(" ")}`.toLowerCase()}>
              <div class="p-6">
                <div class="flex items-start gap-4">
                  <div class="h-14 w-14 shrink-0 overflow-hidden rounded-full border border-border bg-muted">
                    <img src={`${import.meta.env.BASE_URL}${s.headshot ?? "placeholder.svg"}`} alt="" class="h-full w-full object-cover" />
                  </div>
                  <div class="min-w-0">
                    <div class="flex flex-wrap items-center gap-2">
                      <div class="truncate text-base font-semibold text-foreground">{s.name}</div>
                      <Badge variant="secondary" class="capitalize">{s.role}</Badge>
                    </div>
                    <div class="mt-1 text-sm text-muted-foreground">{s.affiliation}</div>
                  </div>
                </div>

                <p class="mt-4 text-sm text-muted-foreground">{s.bio}</p>

                {s.keywords?.length ? (
                  <div class="mt-4 flex flex-wrap gap-2">
                    {s.keywords.slice(0, 6).map((k) => (
                      <Badge variant="outline">{k}</Badge>
                    ))}
                  </div>
                ) : null}
              </div>
            </Card>
          ))}
        </div>
      ) : (
        <div class="mt-10 rounded-lg border border-border bg-background p-10 text-center text-sm text-muted-foreground">
          Speaker information will appear here when announced.
        </div>
      )}
    </div>
  </section>

  <script is:inline>
    const search = document.getElementById("speakerSearch");
    const role = document.getElementById("roleFilter");
    const cards = Array.from(document.querySelectorAll(".speaker-card"));

    function apply() {
      const q = (search?.value || "").trim().toLowerCase();
      const r = role?.value || "all";
      cards.forEach((c) => {
        const text = c.getAttribute("data-text") || "";
        const cardRole = c.getAttribute("data-role") || "";
        const okText = !q || text.includes(q);
        const okRole = (r === "all") || (cardRole === r);
        c.style.display = (okText && okRole) ? "" : "none";
      });
    }

    search?.addEventListener("input", apply);
    role?.addEventListener("change", apply);
  </script>
</BaseLayout>
